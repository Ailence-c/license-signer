<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆæƒæ–‡ä»¶ç”Ÿæˆå™¨ - æ‰‹æœºç‰ˆ</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray: #6b7280;
            --light-gray: #f3f4f6;
            --white: #ffffff;
            --black: #111827;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--black);
            line-height: 1.5;
            min-height: 100vh;
            padding: 16px;
            touch-action: manipulation;
        }
        .container {
            max-width: 100%;
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        .header p {
            color: var(--gray);
            font-size: 0.875rem;
        }
        .server-info {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }
        .server-info h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: var(--black);
        }
        .server-info input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
            margin-top: 8px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--black);
        }
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            background: var(--white);
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
            touch-action: manipulation;
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }
        .btn-primary:active {
            background: var(--primary-dark);
        }
        .btn-secondary {
            background: var(--light-gray);
            color: var(--black);
            border: 1px solid #e5e7eb;
        }
        .btn-success {
            background: var(--success);
            color: var(--white);
        }
        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }
        .tabs {
            display: flex;
            background: var(--light-gray);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 24px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .tab.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .result-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid var(--primary);
            display: none;
        }
        .license-preview {
            background: #1f2937;
            color: #d1d5db;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .file-list {
            margin-top: 16px;
        }
        .file-item {
            background: var(--white);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .file-info {
            flex: 1;
            min-width: 0;
        }
        .file-name {
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-meta {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 2px;
        }
        .file-actions {
            display: flex;
            gap: 8px;
        }
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }
        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease;
        }
        .message-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .message-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .message-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .message-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .actions-row {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        .actions-row .btn {
            flex: 1;
        }
        .ip-help {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .quick-ip {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .ip-btn {
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        @media (max-width: 640px) {
            body {
                padding: 12px;
            }
            .container {
                padding: 20px;
            }
            .actions-row {
                flex-direction: column;
            }
        }
        .license-preview::-webkit-scrollbar {
            width: 4px;
        }
        .license-preview::-webkit-scrollbar-track {
            background: #374151;
        }
        .license-preview::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” æˆæƒæ–‡ä»¶ç”Ÿæˆå™¨</h1>
            <p>æ‰‹æœºç‰ˆ - å·²éªŒè¯æœ‰æ•ˆçš„ç­¾åæ–¹æ¡ˆ</p>
        </div>
        <div class="server-info">
            <h3>ğŸ“¡ æœåŠ¡å™¨è®¾ç½®</h3>
            <input type="text" id="serverUrl" placeholder="http://192.168.x.x:5000" value="">
            <div class="ip-help">
                <span>ğŸ’¡ ç¡®ä¿æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€WiFiï¼Œè¾“å…¥ç”µè„‘IPåœ°å€</span>
            </div>
            <div class="quick-ip">
                <button class="ip-btn" onclick="setServerUrl('http://192.168.1.193:5000')">æœ¬åœ°</button>
                <button class="ip-btn" onclick="setServerUrl('http://192.168.1.220:5000')">å¸¸ç”¨IP1</button>
                <button class="ip-btn" onclick="setServerUrl('http://192.168.1.001:5000')">å¸¸ç”¨IP2</button>
            </div>
        </div>
        <div class="tabs">
            <button class="tab active" data-tab="single">å•æœºå‘è¯</button>
            <button class="tab" data-tab="batch">æ‰¹é‡å‘è¯</button>
            <button class="tab" data-tab="files">æ–‡ä»¶ç®¡ç†</button>
            <button class="tab" data-tab="logs">æˆæƒæ—¥å¿—</button>
        </div>
        <div class="form-group">
            <label class="form-label">ğŸ“… æˆæƒå¤©æ•°</label>
            <input type="number" class="form-input" id="days" value="365" min="1">
        </div>
        <div class="form-group">
            <label class="form-label">ğŸ“ è®¢å•ç¼–å·ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" class="form-input" id="orderId" placeholder="ä»…ç”¨äºè®°å½•">
        </div>
        <div class="form-group">
            <label class="form-label">ğŸ’¡ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" class="form-input" id="remark" placeholder="ä»…ç”¨äºè®°å½•">
        </div>
        <!-- å•æœºå‘è¯ -->
        <div id="single" class="tab-content active">
            <div class="form-group">
                <label class="form-label">ğŸ”¢ æœºå™¨ç </label>
                <input type="text" class="form-input" id="fingerprint" 
                       placeholder="è¾“å…¥64ä½æœºå™¨ç " 
                       pattern="[a-fA-F0-9]{64}"
                       title="è¯·è¾“å…¥64ä½åå…­è¿›åˆ¶æœºå™¨ç ">
            </div>
            <button class="btn btn-primary" id="generateSingleBtn">
                ğŸš€ ç”Ÿæˆæˆæƒæ–‡ä»¶
            </button>
        </div>
        <!-- æ‰¹é‡å‘è¯ -->
        <div id="batch" class="tab-content">
            <div class="form-group">
                <label class="form-label">ğŸ“‹ æœºå™¨ç åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                <textarea class="form-input form-textarea" id="fingerprints" 
                          placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªæœºå™¨ç &#10;ä¾‹å¦‚ï¼š&#10;1140b2e368f661d7a01adedda63b7c90b634917639501cd514f689fa56e35f6f"></textarea>
            </div>
            <button class="btn btn-primary" id="generateBatchBtn">
                ğŸš€ æ‰¹é‡ç”Ÿæˆ
            </button>
        </div>
        <!-- æ–‡ä»¶ç®¡ç† -->
        <div id="files" class="tab-content">
            <div class="file-list" id="fileList"></div>
            <button class="btn btn-secondary" id="refreshFilesBtn">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        </div>
        <!-- æˆæƒæ—¥å¿— -->
        <div id="logs" class="tab-content">
            <button class="btn btn-primary" id="loadLogsBtn">ğŸ”„ åŠ è½½æœåŠ¡å™¨æ—¥å¿—</button>
            <button class="btn btn-success" id="downloadLogsBtn" style="margin-top:10px;">ğŸ“¥ ä¸‹è½½æ—¥å¿— CSV</button>
            <div id="logsList" style="margin-top:16px; max-height:400px; overflow-y:auto;"></div>
        </div>
        <!-- ç»“æœå±•ç¤º -->
        <div class="result-card" id="resultCard">
            <h3 style="margin-bottom: 16px; font-size: 1.25rem;">ğŸ“„ æˆæƒæ–‡ä»¶é¢„è§ˆ</h3>
            <div class="license-preview" id="licensePreview"></div>
            <div class="actions-row">
                <button class="btn btn-success" id="downloadBtn">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</button>
                <button class="btn btn-secondary" id="copyBtn">ğŸ“‹ å¤åˆ¶å†…å®¹</button>
                <button class="btn btn-warning" id="closeBtn">âœ• å…³é—­</button>
            </div>
        </div>
        <div id="messageArea"></div>
    </div>
    <script>
        let currentLicense = null;
        let currentFileName = '';

        // å…¨å±€å‡½æ•°ï¼šä¾› HTML onclick ä½¿ç”¨
        window.setServerUrl = function(url) {
            document.getElementById('serverUrl').value = url;
            showMessage(`å·²è®¾ç½®æœåŠ¡å™¨åœ°å€: ${url}`, 'info');
        };

        document.addEventListener('DOMContentLoaded', function() {
            setDefaultServerUrl();
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    if (tabId === 'files') refreshFileList();
                    if (tabId === 'logs') { /* å¯æ‰‹åŠ¨åŠ è½½ */ }
                });
            });
            document.getElementById('generateSingleBtn').addEventListener('click', generateSingle);
            document.getElementById('generateBatchBtn').addEventListener('click', generateBatch);
            document.getElementById('refreshFilesBtn').addEventListener('click', refreshFileList);
            document.getElementById('downloadBtn').addEventListener('click', downloadLicense);
            document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
            document.getElementById('closeBtn').addEventListener('click', hideResult);
            document.getElementById('loadLogsBtn').addEventListener('click', loadLogs);
            document.getElementById('downloadLogsBtn').addEventListener('click', downloadLogs);
            document.getElementById('fingerprint').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') generateSingle();
            });
            refreshFileList();
        });

        function setDefaultServerUrl() {
            document.getElementById('serverUrl').value = 'http://localhost:5000';
        }

        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            while (messageArea.firstChild) messageArea.removeChild(messageArea.firstChild);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            let icon = 'ğŸ’¡';
            if (type === 'success') icon = 'âœ…';
            if (type === 'error') icon = 'âŒ';
            if (type === 'warning') icon = 'âš ï¸';
            messageDiv.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span><span>${message}</span>`;
            messageArea.appendChild(messageDiv);
            const duration = type === 'error' ? 5000 : 3000;
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 300);
            }, duration);
        }

        function getServerUrl() {
            let url = document.getElementById('serverUrl').value.trim();
            if (!url) {
                showMessage('è¯·å…ˆè®¾ç½®æœåŠ¡å™¨åœ°å€', 'error');
                return null;
            }
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'http://' + url;
            }
            return url;
        }

        // ä¿®å¤ fetch è¶…æ—¶é—®é¢˜ï¼ˆä½¿ç”¨ AbortControllerï¼‰
        async function checkServerConnection() {
            const serverUrl = getServerUrl();
            if (!serverUrl) return false;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                const response = await fetch(`${serverUrl}/health`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 'ok';
                }
                return false;
            } catch (error) {
                console.error('æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error);
                return false;
            }
        }

        async function generateSingle() {
            const fingerprint = document.getElementById('fingerprint').value.trim();
            const days = parseInt(document.getElementById('days').value) || 365;
            const orderId = document.getElementById('orderId').value.trim();
            const remark = document.getElementById('remark').value.trim();
            const serverUrl = getServerUrl();
            if (!serverUrl) return;
            if (!fingerprint) return showMessage('è¯·è¾“å…¥æœºå™¨ç ', 'error');
            if (!/^[a-fA-F0-9]{64}$/.test(fingerprint)) return showMessage('æœºå™¨ç å¿…é¡»æ˜¯64ä½åå…­è¿›åˆ¶å­—ç¬¦', 'error');

            const button = document.getElementById('generateSingleBtn');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loading"></span> è¿æ¥æœåŠ¡å™¨...';
            button.disabled = true;

            try {
                const isConnected = await checkServerConnection();
                if (!isConnected) {
                    showMessage('æ— æ³•è¿æ¥åˆ°ç­¾åæœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š1. æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®ï¼›2. ç”µè„‘é˜²ç«å¢™æ˜¯å¦å…è®¸5000ç«¯å£ï¼›3. æ˜¯å¦è¿è¡Œäº†python server.py', 'error');
                    return;
                }
                button.innerHTML = '<span class="loading"></span> æ­£åœ¨ç”Ÿæˆç­¾å...';
                const response = await fetch(`${serverUrl}/sign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fingerprint, days, orderId }) // âœ… ä¼  orderId
                });
                if (!response.ok) throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`);
                const result = await response.json();
                if (result.success) {
                    const licenseData = { f: fingerprint, e: result.expiration, sig: result.signature };
                    currentLicense = licenseData;
                    currentFileName = `${fingerprint}.license`;
                    saveToLocalStorage(fingerprint, licenseData, orderId, remark);
                    showResult(licenseData);
                    showMessage('âœ… æˆæƒæ–‡ä»¶ç”ŸæˆæˆåŠŸï¼', 'success');
                } else {
                    throw new Error(result.error || 'ç­¾åå¤±è´¥');
                }
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                showMessage('âŒ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function generateBatch() {
            const fingerprintsText = document.getElementById('fingerprints').value.trim();
            const days = parseInt(document.getElementById('days').value) || 365;
            const orderId = document.getElementById('orderId').value.trim();
            const remark = document.getElementById('remark').value.trim();
            const serverUrl = getServerUrl();
            if (!serverUrl) return;
            if (!fingerprintsText) return showMessage('è¯·è¾“å…¥æœºå™¨ç åˆ—è¡¨', 'error');

            // âœ… ä¿®å¤ï¼šä½¿ç”¨ '\n' è€Œä¸æ˜¯å­—é¢æ¢è¡Œç¬¦
            const fingerprints = fingerprintsText.split(/\r?\n/).map(f => f.trim()).filter(f => f && /^[a-fA-F0-9]{64}$/.test(f));

            if (fingerprints.length === 0) return showMessage('æ²¡æœ‰æœ‰æ•ˆçš„æœºå™¨ç ï¼ˆå¿…é¡»æ˜¯64ä½åå…­è¿›åˆ¶ï¼‰', 'error');

            const button = document.getElementById('generateBatchBtn');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loading"></span> è¿æ¥æœåŠ¡å™¨...';
            button.disabled = true;

            try {
                const isConnected = await checkServerConnection();
                if (!isConnected) {
                    showMessage('æ— æ³•è¿æ¥åˆ°ç­¾åæœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œç½‘ç»œ', 'error');
                    return;
                }
                button.innerHTML = `<span class="loading"></span> æ­£åœ¨æ‰¹é‡ç”Ÿæˆ ${fingerprints.length} ä¸ªæ–‡ä»¶...`;
                const response = await fetch(`${serverUrl}/batch_sign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fingerprints, days, orderId }) // âœ… ä¼  orderId
                });
                if (!response.ok) throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`);
                const result = await response.json();
                if (result.success) {
                    result.results.forEach(item => {
                        const licenseData = { f: item.fingerprint, e: item.expiration, sig: item.signature };
                        saveToLocalStorage(item.fingerprint, licenseData, orderId, remark);
                    });
                    showMessage(`âœ… æˆåŠŸç”Ÿæˆ ${result.succeeded} ä¸ªæˆæƒæ–‡ä»¶`, 'success');
                    refreshFileList();
                } else {
                    throw new Error(result.error || 'æ‰¹é‡ç­¾åå¤±è´¥');
                }
            } catch (error) {
                console.error('æ‰¹é‡ç”Ÿæˆå¤±è´¥:', error);
                showMessage('âŒ æ‰¹é‡ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function saveToLocalStorage(fingerprint, licenseData, orderId = '', remark = '') {
            try {
                let files = JSON.parse(localStorage.getItem('license_files') || '{}');
                files[fingerprint] = { licenseData, fileName: `${fingerprint}.license`, created: new Date().toISOString(), orderId, remark, size: JSON.stringify(licenseData).length };
                localStorage.setItem('license_files', JSON.stringify(files));
                return true;
            } catch (error) {
                return false;
            }
        }

        // âœ… æ–°å¢ï¼šæ˜¾ç¤ºæ‹¼æ¥å€¼
        function showResult(licenseData) {
            const preview = document.getElementById('licensePreview');
            const jsonText = JSON.stringify(licenseData, null, 2);
            const concatenated = licenseData.f + licenseData.e.toString() + licenseData.sig;
            preview.innerHTML = `
                <div style="margin-bottom:12px; font-weight:bold; color:#4f46e5;">ğŸ“„ åŸå§‹æˆæƒå†…å®¹ï¼ˆ.license æ–‡ä»¶ï¼‰</div>
                <pre style="background:#1f2937; padding:12px; border-radius:6px; color:#d1d5db;">${jsonText}</pre>
                <div style="margin-top:16px; margin-bottom:8px; font-weight:bold; color:#10b981;">ğŸ”— æ‹¼æ¥å€¼ï¼ˆf + e + sigï¼‰</div>
                <div id="concatenatedValue" style="word-break:break-all; background:#374151; color:#e5e6f0; padding:10px; border-radius:6px; font-family:monospace; font-size:0.85rem;">
                    ${concatenated}
                </div>
            `;
            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideResult() {
            document.getElementById('resultCard').style.display = 'none';
            currentLicense = null;
        }

        function downloadLicense() {
            if (!currentLicense) return showMessage('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶', 'error');
            try {
                const blob = new Blob([JSON.stringify(currentLicense, null, 2)], { type: 'application/json' });
                if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                    const reader = new FileReader();
                    reader.onload = e => window.location.href = e.target.result;
                    reader.readAsDataURL(blob);
                } else {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = currentFileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
                showMessage('âœ… æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½', 'success');
            } catch (error) {
                showMessage('âŒ ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function copyToClipboard() {
            const concatDiv = document.getElementById('concatenatedValue');
            if (!concatDiv) {
                showMessage('æ‹¼æ¥å€¼å°šæœªç”Ÿæˆ', 'error');
                return;
            }
            const textToCopy = concatDiv.textContent.trim();
            if (!textToCopy) {
                showMessage('æ‹¼æ¥å€¼ä¸ºç©º', 'error');
                return;
            }
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(textToCopy);
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
                showMessage('âœ… å·²å¤åˆ¶æ‹¼æ¥å€¼åˆ°å‰ªè´´æ¿', 'success');
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                showMessage('âŒ å¤åˆ¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        function refreshFileList() {
            try {
                const fileList = document.getElementById('fileList');
                let raw = localStorage.getItem('license_files');
                let files = {};
        
                // å®‰å…¨è§£æ JSON
                if (raw && typeof raw === 'string') {
                    try {
                        files = JSON.parse(raw);
                        // ç¡®ä¿ç»“æœæ˜¯å¯¹è±¡
                        if (files === null || typeof files !== 'object') {
                            files = {};
                        }
                    } catch (parseError) {
                        console.warn('localStorage æ•°æ®æŸåï¼Œå·²é‡ç½®:', parseError);
                        localStorage.removeItem('license_files');
                        files = {};
                        showMessage('âš ï¸ æœ¬åœ°æ–‡ä»¶åˆ—è¡¨æ•°æ®å¼‚å¸¸ï¼Œå·²è‡ªåŠ¨é‡ç½®', 'warning');
                    }
                }
        
                if (Object.keys(files).length === 0) {
                    fileList.innerHTML = `<div style="text-align: center; padding: 40px 20px; color: #6b7280;">ğŸ“‚ æš‚æ— æˆæƒæ–‡ä»¶</div>`;
                    return;
                }
        
                let html = '';
                const fileEntries = Object.entries(files).sort((a, b) => new Date(b[1].created) - new Date(a[1].created));
                fileEntries.forEach(([fingerprint, fileInfo]) => {
                    // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ fileInfo ç»“æ„å®Œæ•´
                    if (!fileInfo || !fileInfo.licenseData) return;
                    const created = new Date(fileInfo.created).toLocaleString();
                    const expires = new Date(fileInfo.licenseData.e * 1000).toLocaleDateString();
                    const sizeKB = (fileInfo.size / 1024).toFixed(2);
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">${fileInfo.fileName || fingerprint}.license</div>
                                <div class="file-meta">
                                    åˆ›å»º: ${created} | å¤§å°: ${sizeKB} KB<br>
                                    è¿‡æœŸ: ${expires}
                                    ${fileInfo.orderId ? ` | è®¢å•: ${fileInfo.orderId}` : ''}
                                    ${fileInfo.remark ? ` | å¤‡æ³¨: ${fileInfo.remark}` : ''}
                                </div>
                            </div>
                            <div class="file-actions">
                                <button class="action-btn" style="background: #10b981; color: white;" onclick="downloadFile('${fingerprint}')">ä¸‹è½½</button>
                                <button class="action-btn" style="background: #ef4444; color: white;" onclick="deleteFile('${fingerprint}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
                fileList.innerHTML = html;
            } catch (error) {
                console.error('åˆ·æ–°æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                showMessage('âŒ åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        window.downloadFile = function(fingerprint) {
            try {
                const files = JSON.parse(localStorage.getItem('license_files') || '{}');
                const fileInfo = files[fingerprint];
                if (!fileInfo) return showMessage('æ–‡ä»¶ä¸å­˜åœ¨', 'error');
                const blob = new Blob([JSON.stringify(fileInfo.licenseData, null, 2)], { type: 'application/json' });
                if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                    const reader = new FileReader();
                    reader.onload = e => window.location.href = e.target.result;
                    reader.readAsDataURL(blob);
                } else {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileInfo.fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
                showMessage('âœ… æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½', 'success');
            } catch (error) {
                showMessage('âŒ ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        };

        window.deleteFile = function(fingerprint) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæˆæƒæ–‡ä»¶å—ï¼Ÿ')) {
                try {
                    const files = JSON.parse(localStorage.getItem('license_files') || '{}');
                    delete files[fingerprint];
                    localStorage.setItem('license_files', JSON.stringify(files));
                    refreshFileList();
                    showMessage('âœ… æ–‡ä»¶å·²åˆ é™¤', 'success');
                } catch (error) {
                    showMessage('âŒ åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            }
        };

        // --- æ—¥å¿—åŠŸèƒ½ ---
        async function loadLogs() {
            const serverUrl = getServerUrl();
            if (!serverUrl) return;
            const btn = document.getElementById('loadLogsBtn');
            const original = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> åŠ è½½ä¸­...';
            btn.disabled = true;
            try {
                const res = await fetch(`${serverUrl}/logs`);
                const data = await res.json();
                if (data.success) {
                    displayLogs(data.logs);
                } else {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (err) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', err);
                showMessage('âŒ åŠ è½½æ—¥å¿—å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        function displayLogs(logs) {
            const container = document.getElementById('logsList');
            if (logs.length === 0) {
                container.innerHTML = '<div class="message message-info">æš‚æ— æ—¥å¿—è®°å½•</div>';
                return;
            }
            let html = `
                <table style="width:100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr style="background:#f3f4f6;">
                            <th style="padding:8px; border:1px solid #ddd; text-align:left;">è®¢å•å·</th>
                            <th style="padding:8px; border:1px solid #ddd; text-align:left;">æœºå™¨ç </th>
                            <th style="padding:8px; border:1px solid #ddd; text-align:left;">ç­¾å‘æ—¶é—´</th>
                            <th style="padding:8px; border:1px solid #ddd; text-align:left;">åˆ°æœŸæ—¶é—´</th>
							<th style="padding:8px; border:1px solid #ddd; text-align:left;">æˆæƒæ–‡ä»¶å†…å®¹</th>
							<th style="padding:8px; border:1px solid #ddd; text-align:left;">f+e+sigæ‹¼æ¥å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            logs.forEach(row => {
                html += `
                    <tr>
                        <td style="padding:6px; border:1px solid #eee;">${row['è®¢å•å·'] || 'â€”'}</td>
                        <td style="padding:6px; border:1px solid #eee; font-family:monospace; font-size:0.8rem;">${row['æœºå™¨ç ']}</td>
                        <td style="padding:6px; border:1px solid #eee;">${row['æˆæƒç­¾å‘æ—¥æœŸ']}</td>
                        <td style="padding:6px; border:1px solid #eee;">${row['æˆæƒåˆ°æœŸæ—¥æœŸ']}</td>
						<td style="padding:6px; border:1px solid #eee; font-family:monospace; font-size:0.8rem;">${row['æˆæƒæ–‡ä»¶å†…å®¹']}</td>
						<td style="padding:6px; border:1px solid #eee; font-family:monospace; font-size:0.8rem;">${row['f+e+sigæ‹¼æ¥å€¼']}</td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function downloadLogs() {
            const serverUrl = getServerUrl();
            if (!serverUrl) return;
            window.open(`${serverUrl}/download_logs`, '_blank');
        }
    </script>
</body>
</html>